<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>Alphabet Animal Game — Forest Edition</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Baloo+2:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-deep:#2f5d50; --bg-mid:#4f7f6c; --bg-light:#a8c7a7;
    --card:#fff8e8; --ink:#243829; --wood:#7b5a35; --moss:#557a5a; --glow:#f6f0c8;
  }
  html,body{height:100%}
  body{margin:0;color:var(--ink);font-family:"Noto Sans",system-ui,-apple-system,Segoe UI,Arial,sans-serif;overflow-x:hidden}
  .scene{
    min-height:100dvh; position:relative; isolation:isolate; padding:22px;
    background:
      radial-gradient(80% 60% at 50% -10%, #ffffff40 0%, #ffffff00 60%),
      radial-gradient(1200px 1000px at 50% -30%, #e7f2e7 0%, #d0e7d4 40%, transparent 60%),
      linear-gradient(180deg, var(--bg-mid) 0%, var(--bg-light) 60%);
  }
  .canopy{position:fixed; inset:0; pointer-events:none; z-index:-1; background:
      radial-gradient(1200px 800px at 20% -10%, #193c34 20%, #0000 60%),
      radial-gradient(900px 700px at 80% -15%, #1b3f36 25%, #0000 60%),
      radial-gradient(700px 600px at 50% 0%, #21463c 20%, #0000 60%); mix-blend-mode:multiply; opacity:.8;}
  .hills{position:fixed; left:0; right:0; bottom:-2%; height:28vh; z-index:0; pointer-events:none; background:
      radial-gradient(60% 100% at 20% 100%, #3f6f5f 0 60%, #0000 61%),
      radial-gradient(55% 95% at 80% 100%, #3b6a5a 0 60%, #0000 61%),
      radial-gradient(80% 120% at 50% 120%, #487b69 0 60%, #0000 61%); filter: blur(2px) saturate(.95);}
  .fireflies{position:fixed; inset:0; pointer-events:none; z-index:1; overflow:hidden}
  .fireflies i{position:absolute; width:6px; height:6px; border-radius:50%; background: radial-gradient(circle, #fff 0 35%, #fff8 36% 60%, transparent 61%); animation: fly 10s linear infinite, twinkle 1.8s ease-in-out infinite; opacity:.65;}
  @keyframes twinkle{0%,100%{transform:scale(1);opacity:.4}50%{transform:scale(1.6);opacity:1}}
  @keyframes fly{0%{transform:translateY(0) translateX(0)}50%{transform:translateY(-120px) translateX(60px)}100%{transform:translateY(0) translateX(0)}}
  h1{margin:0 0 10px;text-align:center;letter-spacing:.5px;color:#f2f2df;text-shadow:0 3px 10px rgba(0,0,0,.25), 0 0 24px #e9f1c7;font-weight:900}
  .panel{max-width:1100px;margin:12px auto;position:relative;z-index:2;background:linear-gradient(180deg,#fffef9, #fff9ed);border:1px solid #e8e0c8;border-radius:18px;padding:14px 16px;box-shadow:0 14px 36px rgba(21,41,34,.22), inset 0 0 0 2px #fff7}
  .panel h3{margin:0 0 6px;color:#3f5c4c}
  button{padding:10px 18px;margin:8px;border:none;border-radius:14px;background:linear-gradient(180deg,#8c6a3f,#6f502c);color:#fff;cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,.18), inset 0 0 0 1px #0003;position:relative}
  button:before{content:"";position:absolute;inset:2px;border-radius:12px;background:linear-gradient(180deg,#a17845aa,#7b5a35aa);opacity:.25;pointer-events:none}
  button:hover{filter:brightness(1.02)}
  button:active{transform:translateY(1px)}
  #topBar{display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:wrap;margin-top:6px}
  #scoreBoard{background:#fffbf0;border:1px solid #efe2c7;border-radius:12px;padding:8px 12px;box-shadow:inset 0 0 0 1px #fff6}
  #timer{font-weight:900;padding:8px 12px;border-radius:12px;background:#f7ffe7;border:1px solid #d7efc9;box-shadow:inset 0 0 0 1px #fff6}
  #timer.red{background:#fff0f0;border-color:#ffd0d0;color:#931c1c}
  #questionLetter{font-family:'Fredoka One', sans-serif;font-size:100px;line-height:1;color:#2a4d69;margin:12px 0 6px;min-height:120px;text-shadow:0 4px 10px rgba(0,0,0,.08)}
  .choice{font-family:'Baloo 2', cursive;display:inline-flex;align-items:center;justify-content:center;margin:10px;padding:20px 26px;border:4px solid transparent;border-radius:18px;background:linear-gradient(180deg,#fdf5e1,#f4e2bd);cursor:pointer;font-size:50px;min-width:150px;min-height:86px;box-shadow:0 10px 20px rgba(38,58,48,.22), inset 0 0 0 1px #0001;transition:transform .15s ease, background .15s ease, box-shadow .15s ease, filter .15s ease}
  .choice:hover{transform:translateY(-2px);filter:saturate(1.05)}
  .ok{background:linear-gradient(180deg,#e9fbdf,#d1f2c4)!important}
  .bad{background:linear-gradient(180deg,#ffe7e7,#ffd6d6)!important}
  #flash{min-height:1.2em;margin:6px 0 4px;color:#273d30;font-weight:700;text-shadow:0 1px 0 #fff}
  #leaderboard,#achBox{background:linear-gradient(180deg,#fffdf7,#fff6e8);border:1px solid #ecdcbf;border-radius:16px;padding:12px 14px;box-shadow:0 10px 24px rgba(21,41,34,.16), inset 0 0 0 2px #fff7}
  #leaderTabs{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
  #leaderTabs button{background:linear-gradient(180deg,#e6f2e6,#d9e9dc);color:#1f3b2b}
  #leaderTabs button.active{background:linear-gradient(180deg,#3f6b56,#2f5645);color:#fff}
  #leaderboard table{width:100%;border-collapse:separate;border-spacing:0 10px}
  #leaderboard th,#leaderboard td{padding:8px 10px}
  .lb-row{background:linear-gradient(180deg,#f7fbf5,#f0f7f0);border:1px solid #dce9dc;border-radius:12px;box-shadow:0 6px 14px rgba(21,41,34,.08)}
  .rank1{border:2px solid #d4af37!important;background:linear-gradient(180deg,#fff8e1,#fff3cd)}
  .rank2{border:2px solid #c0c0c0!important;background:linear-gradient(180deg,#f7f7f7,#ededed)}
  .rank3{border:2px solid #cd7f32!important;background:linear-gradient(180deg,#fff1e6,#ffe3cf)}
  .nameCell{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .svgTrophy{width:20px;height:20px;display:inline-block;vertical-align:middle}
  .badgeIcons{display:inline-flex;gap:4px;margin-left:6px;flex-wrap:wrap}
  .miniBadge{font-size:16px;filter:drop-shadow(0 1px 2px rgba(0,0,0,.15))}
  .badgeWrap{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
  .ach{display:flex;gap:10px;align-items:center;background:#f6faf4;border:1px solid #e3efe3;border-radius:12px;padding:10px}
  .ach.lock{filter:grayscale(.9) contrast(.85);opacity:.65}
  .ach .ic{font-size:22px}
  .ach .name{font-weight:800}
  #alphabetBoardWrap{background:linear-gradient(180deg,#f9fff7,#f0faef);border:1px solid #e4f0e4;backdrop-filter:blur(4px);padding:12px;border-radius:16px;box-shadow:0 10px 24px rgba(21,41,34,.14), inset 0 0 0 2px #fff7}
  #alphabetBoard{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
  .letterCard{display:flex;align-items:center;gap:10px;background:linear-gradient(180deg,#f7fff7,#eef7ee);border:1px solid #d6e7d6;border-radius:14px;padding:8px 10px;cursor:pointer;box-shadow:0 6px 14px rgba(21,41,34,.08)}
  .letterCard:hover{transform:translateY(-1px);background:#ffffff}
  .mini{width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;background:radial-gradient(120% 120% at 30% 20%, #fff 0%, #f6f1dd 45%, #e8f0e6 100%);box-shadow:inset 0 0 0 1px #0001,0 3px 8px rgba(0,0,0,.12)}
  .lab{display:flex;flex-direction:column;line-height:1.1}
  .lab .l{font-weight:900}
  .lab .a{font-size:.92rem;color:#455}
  @media (max-width:520px){.choice{min-width:46%;font-size:40px;padding:16px 18px} #questionLetter{font-size:72px; min-height:86px}}
  .modal-backdrop{position:fixed; inset:0; background:rgba(17,30,24,.45); display:none; align-items:center; justify-content:center; z-index:1000;}
  .modal{width:min(560px,92vw); border-radius:18px; padding:16px; background:linear-gradient(180deg,#fefcf6,#fbf1df); border:1px solid #eadfc6; box-shadow:0 20px 50px rgba(7,18,14,.35), inset 0 0 0 2px #fff7; text-align:left}
  .modal h3{margin:0 0 6px; color:#325244}
  .modal p{margin:0 0 10px; color:#456}
  .opt{display:flex; gap:10px; align-items:center; background:#f3f9f3; border:1px solid #e1ede1; padding:10px; border-radius:12px; margin:8px 0;}
  .row{display:flex; gap:8px; align-items:center; margin-top:6px; flex-wrap:wrap}
  .modal .actions{display:flex; gap:8px; justify-content:flex-end; margin-top:12px}
  .modal input[type="text"]{flex:1; padding:10px 12px; border:1px solid #d9e2d9; border-radius:10px; font-size:1rem}
  #fxCanvas{position:fixed; inset:0; width:100%; height:100%; pointer-events:none; z-index:999;}
  #comboHud{position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); font-family:'Baloo 2', cursive; font-size:100px; line-height:1; color:#d4af37; text-shadow:0 2px 0 #b9902a, 0 0 28px rgba(212,175,55,.55); -webkit-text-stroke:1px rgba(0,0,0,.18); filter: drop-shadow(0 10px 18px rgba(0,0,0,.25)); display:none; pointer-events:none; z-index:1001; white-space:nowrap}
  #comboHud .flame{display:inline-block; margin:0 .15em; filter:drop-shadow(0 0 10px rgba(255,120,0,.45)); animation: flameFlicker 1.2s infinite ease-in-out;}
  .comboPop{ animation: comboPop .7s ease-out; }
  @keyframes comboPop{0%{transform:translate(-50%,-50%) scale(.6);opacity:0}40%{transform:translate(-50%,-50%) scale(1.25);opacity:1}100%{transform:translate(-50%,-50%) scale(1);opacity:.98}}
  @keyframes flameFlicker{0%,100%{transform:translateY(0) rotate(0deg);opacity:.95}50%{transform:translateY(-4px) rotate(-4deg);opacity:1}}

  /* 成就解鎖吐司 */
  #unlockToast{position:fixed; left:50%; top:18px; transform:translateX(-50%) translateY(-40px); z-index:1002; display:none; pointer-events:none; background:linear-gradient(135deg,#fff9e6,#ffffff); border:2px solid #ffd36b; border-radius:16px; padding:10px 14px; box-shadow:0 16px 38px rgba(0,0,0,.18), inset 0 0 0 1px #fff6; font-family:'Baloo 2', cursive; color:#6b4e00; white-space:pre-line}
  #unlockToast.show{ display:block; animation:toastSlide .9s ease forwards; }
  #unlockToast .title{font-weight:800; font-size:18px}
  #unlockToast .line{display:flex; gap:8px; align-items:center}
  #unlockToast .icon{font-size:22px}
  #unlockToast .shine{position:absolute; inset:0; overflow:hidden; border-radius:14px; pointer-events:none;}
  #unlockToast .shine::before{content:""; position:absolute; top:-60%; left:-20%; width:60%; height:220%; transform:rotate(25deg); background:linear-gradient(90deg,transparent,rgba(255,255,255,.7),transparent); animation:shinePass 1.2s ease .15s forwards;}
  @keyframes toastSlide{0%{transform:translateX(-50%) translateY(-40px);opacity:0}40%{transform:translateX(-50%) translateY(0);opacity:1}80%{transform:translateX(-50%) translateY(0);opacity:1}100%{transform:translateX(-50%) translateY(-20px);opacity:0}}
  @keyframes shinePass{0%{left:-60%}100%{left:120%}}

  .bgmCtrl{position:fixed; right:14px; top:14px; z-index:1003; display:flex; align-items:center; gap:6px;}
  .bgmBtn{padding:8px 12px; margin:0; border-radius:12px; background:linear-gradient(180deg,#6a845f,#526b4b);}
  .volWrap{display:flex; align-items:center; gap:6px; background:#f0f6ef; border:1px solid #cfe0cf; padding:6px 8px; border-radius:12px; box-shadow:inset 0 0 0 1px #fff6}
  .volWrap input[type=range]{width:120px}
</style>
</head>
<body>
<div class="scene">
  <div class="canopy"></div>
  <div class="hills"></div>
  <div class="fireflies" aria-hidden="true">
    <i style="left:10%; top:60%; animation-delay:.2s"></i>
    <i style="left:22%; top:30%; animation-delay:1.1s"></i>
    <i style="left:40%; top:75%; animation-delay:.6s"></i>
    <i style="left:55%; top:20%; animation-delay:1.4s"></i>
    <i style="left:68%; top:50%; animation-delay:.9s"></i>
    <i style="left:82%; top:35%; animation-delay:1.9s"></i>
  </div>

  <!-- 背景音樂控制 -->
  <div class="bgmCtrl">
    <button class="bgmBtn" id="bgmToggleBtn" title="切換背景音樂" onclick="toggleBGM()">🎵 開啟/關閉 BGM</button>
    <div class="volWrap" title="調整 BGM 音量">
      <span>🔊</span>
      <input id="bgmVol" type="range" min="0" max="1" step="0.01" oninput="setBGMVolume(this.value)" />
    </div>
  </div>

  <h1>Alphabet Animal Game</h1>

  <div id="modeSelect" class="panel" style="text-align:center">
    <h3>選擇模式</h3>
    <button onclick="openScoreModal('upper')">🔠 大寫字母</button>
    <button onclick="openScoreModal('lower')">🔡 小寫字母</button>
    <button onclick="openScoreModal('mixed')">🧭 混合模式</button>
    <button onclick="openScoreModal('extreme')">🌋 極限挑戰（100 題）</button>
    <div style="font-size:.95rem;opacity:.9;margin-top:6px;color:#2a4135">（彈窗選擇「計分 / 不計分」，計分需輸入姓名）</div>
  </div>

  <div class="panel" id="topWrap" style="display:none;">
    <div id="topBar">
      <div id="scoreBoard"></div>
      <div id="timer" aria-live="polite" title="每題 10 秒倒數">⏱ 10s</div>
      <button id="replayBtn" onclick="replayQuestion()">🔊 重播題目</button>
      <button id="giveUpBtn" onclick="openGiveUpModal()" style="background:linear-gradient(180deg,#934343,#6b2323)">🛑 放棄本局</button>
    </div>
    <div id="gameArea" style="margin-top:10px;"></div>
    <div id="flash"></div>
  </div>

  <div id="achBox" class="panel" style="display:none;">
    <div style="font-weight:800;margin-bottom:6px;color:#2f4f40">🏅 闖關獎章</div>
    <div class="badgeWrap" id="achWrap"></div>
  </div>

  <div id="leaderboard" class="panel" style="display:none;">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
      <div style="font-weight:800;margin-bottom:6px;color:#2f4f40">🏆 排行榜（各模式前五名）</div>
      <div id="leaderTabs">
        <button onclick="switchLB('upper')" id="tab-upper" class="active">大寫</button>
        <button onclick="switchLB('lower')" id="tab-lower">小寫</button>
        <button onclick="switchLB('mixed')" id="tab-mixed">混合</button>
        <button onclick="switchLB('extreme')" id="tab-extreme">極限</button>
        <button onclick="clearLeaderboard()" style="margin-left:auto;background:linear-gradient(180deg,#934343,#6b2323)">清空當前榜</button>
      </div>
    </div>
    <table id="lb"></table>
  </div>

  <div id="alphabetBoardWrap" class="panel">
    <div style="font-weight:800;margin-bottom:6px;color:#2f4f40">📚 字母學習板（點擊可發音）</div>
    <div id="alphabetBoard"></div>
  </div>
</div>

<canvas id="fxCanvas"></canvas>
<div id="comboHud"><span class="flame">🔥</span> +5 <span class="flame">🔥</span></div>

<!-- 成就解鎖通知 -->
<div id="unlockToast" aria-live="polite" role="status">
  <div class="shine"></div>
  <div class="title">成就解鎖！</div>
  <div class="line"><span class="icon">🏅</span><span class="text">你獲得了 XXX</span></div>
</div>

<!-- iOS 聲音啟用門檻（首次點擊授權音訊） -->
<div id="soundGate" style="position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center;z-index:2000;">
  <div style="width:min(520px,92vw);background:#fff;border-radius:16px;padding:16px;box-shadow:0 20px 50px rgba(0,0,0,.35);text-align:center">
    <h3 style="margin:0 0 8px">🔊 啟用聲音</h3>
    <p style="margin:0 0 10px;color:#444;line-height:1.5">
      iPhone 需要你先點一下才能播放發音與音樂。<br>
      請確認<i>機身側邊靜音鍵已關閉</i>與<i>音量不為零</i>。
    </p>
    <button onclick="enableSoundIOS()">我已開啟音量，啟用聲音</button>
  </div>
</div>

<!-- 模式選擇彈窗 -->
<div id="scoreModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal">
    <h3 id="modalTitle">選擇遊玩模式</h3>
    <p>你要記分嗎？計分模式會把本局分數寫入排行榜（前五名）。</p>
    <label class="opt"><input type="radio" name="m" value="scored" checked> 計分模式</label>
    <div class="row"><input id="playerName" type="text" placeholder="請輸入玩家姓名（必填）" style="flex:1;min-width:240px"/></div>
    <label class="opt"><input type="radio" name="m" value="practice"> 不計分（練習模式）</label>
    <div class="actions">
      <button onclick="closeScoreModal()" style="background:linear-gradient(180deg,#6d7a76,#46524d)">取消</button>
      <button onclick="confirmScoreChoice()">開始遊戲</button>
    </div>
  </div>
</div>

<!-- 下一關彈窗 -->
<div id="nextModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="nextTitle">
  <div class="modal">
    <h3 id="nextTitle">本關結束，下一步？</h3>
    <p id="nextDesc">你可以回主選單，或直接挑戰尚未進行的關卡：</p>
    <div id="nextList" class="row"></div>
    <div class="actions">
      <button onclick="backToMenu()" style="background:linear-gradient(180deg,#6d7a76,#46524d)">回主選單</button>
    </div>
  </div>
</div>

<!-- 放棄本局彈窗 -->
<div id="giveUpModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="giveUpTitle">
  <div class="modal">
    <h3 id="giveUpTitle">確定要放棄本局嗎？</h3>
    <p>此局分數不會被記錄到排行榜，將返回主選單。</p>
    <div class="actions">
      <button onclick="closeGiveUpModal()" style="background:linear-gradient(180deg,#6d7a76,#46524d)">取消</button>
      <button onclick="giveUpGame()" style="background:linear-gradient(180deg,#934343,#6b2323)">放棄並回首頁</button>
    </div>
  </div>
</div>

<script>
/* ===== 基本資料 ===== */
const animalWords={A:"Ant",B:"Bear",C:"Cat",D:"Dog",E:"Elephant",F:"Fox",G:"Goat",H:"Horse",I:"Iguana",J:"Jaguar",K:"Kangaroo",L:"Lion",M:"Monkey",N:"Newt",O:"Owl",P:"Pig",Q:"Quail",R:"Rabbit",S:"Snake",T:"Tiger",U:"Unicorn",V:"Vulture",W:"Wolf",X:"Xerus",Y:"Yak",Z:"Zebra"};
const animalEmoji={A:"🐜",B:"🐻",C:"🐱",D:"🐶",E:"🐘",F:"🦊",G:"🐐",H:"🐴",I:"🦎",J:"🐆",K:"🦘",L:"🦁",M:"🐵",N:"🦎",O:"🦉",P:"🐷",Q:"🦃",R:"🐰",S:"🐍",T:"🐯",U:"🦄",V:"🦅",W:"🐺",X:"🐿️",Y:"🦬",Z:"🦓"};
const QUESTION_TIME=10;
const EXTREME_QUESTIONS=100;
const NORMAL_QUESTIONS=50;
const UPPER="ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""), LOWER="abcdefghijklmnopqrstuvwxyz".split("");

/* ===== 背景音樂（依模式切換） ===== */
const BGM_SOURCES = {
  home:   "./scenery-142705.mp3",          // 首頁
  upper:  "./scent-of-forest-116193.mp3",  // 大寫
  lower:  "./midnight-forest-184304.mp3",  // 小寫
  mixed:  "./mysterious_night-286709.mp3", // 混合
  extreme:"./mysterious_night-286709.mp3"  // 極限
};
let bgmEl = new Audio(); bgmEl.loop = true; bgmEl.preload = "auto";
let bgmOn  = loadLS("az-bgm-on", true);
let bgmVol = loadLS("az-bgm-vol", 0.35);
bgmEl.volume = clamp(bgmVol, 0, 1);
let currentBgmKey = "home";

/* ===== BGM 音量平衡：WebAudio 管線 + 壓縮器 + Ducking ===== */
let bgmAudioCtx = null, bgmSrcNode = null, bgmGainNode = null, bgmComp = null;
let duckTargetGain = 0.4;   // 約 -8 dB
let normalBgmGain = 1.0;
let isDucked = false;
function ensureBgmPipeline(){
  if (bgmAudioCtx) return;
  const Ctx = window.AudioContext || window.webkitAudioContext;
  bgmAudioCtx = new Ctx();

  bgmGainNode = bgmAudioCtx.createGain();
  bgmGainNode.gain.value = bgmVol * normalBgmGain;

  bgmComp = bgmAudioCtx.createDynamicsCompressor();
  bgmComp.threshold.setValueAtTime(-24, bgmAudioCtx.currentTime);
  bgmComp.knee.setValueAtTime(30, bgmAudioCtx.currentTime);
  bgmComp.ratio.setValueAtTime(12, bgmAudioCtx.currentTime);
  bgmComp.attack.setValueAtTime(0.003, bgmAudioCtx.currentTime);
  bgmComp.release.setValueAtTime(0.25, bgmAudioCtx.currentTime);

  try{
    if (!bgmSrcNode && bgmEl){
      bgmSrcNode = bgmAudioCtx.createMediaElementSource(bgmEl);
      bgmSrcNode.connect(bgmGainNode).connect(bgmComp).connect(bgmAudioCtx.destination);
    }
  }catch(e){/* 同一 <audio> 只能建一次 MediaElementSource，若已建立則忽略 */ }
}
function setBGMVolume(v){
  bgmVol = clamp(parseFloat(v)||0, 0, 1);
  saveLS("az-bgm-vol", bgmVol);
  ensureBgmPipeline();
  const now = bgmAudioCtx ? bgmAudioCtx.currentTime : 0;
  if (bgmGainNode){
    try{
      bgmGainNode.gain.cancelScheduledValues(now);
      bgmGainNode.gain.setTargetAtTime(bgmVol * (isDucked ? duckTargetGain : normalBgmGain), now, 0.05);
    }catch{
      bgmGainNode.gain.value = bgmVol * (isDucked ? duckTargetGain : normalBgmGain);
    }
  }
  const r = document.getElementById('bgmVol'); if(r && Math.abs((+r.value)-bgmVol)>0.001) r.value = bgmVol;
}
async function playBGM(){
  if (!bgmOn) return;
  ensureBgmPipeline();
  try { await unlockAudioOnce(); if (bgmAudioCtx?.state === 'suspended') await bgmAudioCtx.resume(); await bgmEl.play(); } catch {}
}
function pauseBGM(reset=false){ try { bgmEl.pause(); if(reset) bgmEl.currentTime = 0; } catch {} }
function toggleBGM(){ bgmOn = !bgmOn; saveLS("az-bgm-on", bgmOn); updateBgmBtn(); if(bgmOn){ playBGM(); } else { pauseBGM(true); } }
function updateBgmBtn(){ const b = document.getElementById('bgmToggleBtn'); if (b) b.textContent = (bgmOn ? "🎵 關閉 BGM" : "🎵 開啟 BGM"); }
function duckBGM(on){
  ensureBgmPipeline();
  if (!bgmGainNode) return;
  const now = bgmAudioCtx ? bgmAudioCtx.currentTime : 0;
  isDucked = !!on;
  const target = bgmVol * (on ? duckTargetGain : normalBgmGain);
  try{
    bgmGainNode.gain.cancelScheduledValues(now);
    bgmGainNode.gain.setTargetAtTime(target, now, on ? 0.03 : 0.08);
  }catch{ bgmGainNode.gain.value = target; }
}

/* ===== iOS 友善：手勢解鎖與同步執行包裝器 ===== */
let gestureArmed = false;
function armGesture() {
  if (gestureArmed) return;
  gestureArmed = true;
  unlockAudioOnce();
  ensureBgmPipeline();
  try { if (bgmAudioCtx?.state === 'suspended') bgmAudioCtx.resume(); } catch {}
}
window.addEventListener('pointerdown', armGesture, { once: true, passive: true });
window.addEventListener('touchstart', armGesture, { once: true, passive: true });
window.addEventListener('keydown', armGesture, { once: true });
function runInGesture(fn) {
  if (gestureArmed) { fn(); return; }
  const h = () => { fn(); window.removeEventListener('pointerup', h, { capture: true }); };
  window.addEventListener('pointerup', h, { once: true, capture: true });
}

/* ===== 狀態 ===== */
let mode="upper",current="",score=0,streak=0,played=0,locked=false;
let stats={
  correct:0, wrong:0, bestStreak:0,
  playedUpper:false, playedLower:false, playedMixed:false,
  finishedOnce:false, perfectGame:false, replayUsed:false,
  boardClicks:0, boardSet:new Set(), firstThreeCorrect:0
};
let isScoredMode=false, currentPlayerName=null, pendingLetterMode=null;
let perfectBonusApplied=false;
let timeLeft=QUESTION_TIME, timerId=null;

/* ===== 語音：Web Speech 備援 ===== */
let _voiceCache = null, _speakSeq = 0;
function _pickVoice(){
  if (_voiceCache) return _voiceCache;
  const vs = speechSynthesis.getVoices() || [];
  _voiceCache =
    vs.find(v=>/en/i.test(v.lang) && /child|female|junior/i.test(v.name)) ||
    vs.find(v=>/en-US|en-GB/i.test(v.lang)) || null;
  return _voiceCache;
}
speechSynthesis.onvoiceschanged = ()=>{ _voiceCache = null; _pickVoice(); };
function waitSilence(waitMs = 900){
  try{ speechSynthesis.cancel(); }catch(e){}
  const start = performance.now();
  return new Promise(resolve=>{
    (function poll(){
      const quiet = !speechSynthesis.speaking && !speechSynthesis.pending;
      if (quiet || performance.now() - start > waitMs) resolve();
      else setTimeout(poll, 30);
    })();
  });
}
function playUtterance(text, rate, mySeq){
  return new Promise(resolve=>{
    if (mySeq !== _speakSeq) return resolve();
    const u = new SpeechSynthesisUtterance(text);
    u.rate = rate; u.volume = 1;
    const v = _pickVoice(); if (v) u.voice = v;
    u.onend = u.onerror = ()=>resolve();
    try{ speechSynthesis.speak(u); }catch{ resolve(); }
  });
}
async function speakSolo(text, rate=0.9){
  const my = ++_speakSeq;
  await waitSilence(900);
  if (my !== _speakSeq) return;
  await playUtterance(text, rate, my);
}

/* ===== 真人音檔優先（同步立即播放 mp3→wav；失敗退 TTS） ===== */
let _letterPlayer=null, _wordPlayer=null;
function stopLetterAudio(){ if(_letterPlayer){ try{ _letterPlayer.pause(); }catch{} _letterPlayer=null; } }
function stopWordAudio(){ if(_wordPlayer){ try{ _wordPlayer.pause(); }catch{} _wordPlayer=null; } }
function stopAllSpeech(){ try{ speechSynthesis.cancel(); }catch{} stopLetterAudio(); stopWordAudio(); }
function letterSources(L){ const U=L.toUpperCase(); return [`./sounds/letters/${U}.mp3`, `./sounds/letters/${U}.wav`]; }
function wordSources(w){ return [`./sounds/animals/${w}.mp3`, `./sounds/animals/${w}.wav`]; }

// 立即嘗試播放（不 await），保持在使用者手勢同步階段
function immediatePlayLetter(letter){
  stopAllSpeech();
  const U = letter.toUpperCase();
  const s = letterSources(U);
  duckBGM(true);
  const a = new Audio(); a.setAttribute('playsinline',''); a.preload='auto'; a.volume = 1;
  a.onended = () => duckBGM(false);
  _letterPlayer = a;
  a.src = s[0];
  a.play().catch(()=>{ a.src = s[1]; a.play().catch(()=>{ duckBGM(false); if(U==='Z') speakSolo('zee'); else speakSolo(letter); }); });
}
function immediatePlayWord(word){
  const s = wordSources(word);
  duckBGM(true);
  const a = new Audio(); a.setAttribute('playsinline',''); a.preload='auto'; a.volume = 1;
  a.onended = () => duckBGM(false);
  _wordPlayer = a;
  a.src = s[0];
  a.play().catch(()=>{ a.src = s[1]; a.play().catch(()=>{ duckBGM(false); speakSolo(word); }); });
}

/* ===== 音效（答對/答錯 + beep 備援，含 Duck） ===== */
let audioCtx=null;
function ensureAudioCtx(){ if(!audioCtx){const C=window.AudioContext||window.webkitAudioContext; audioCtx=new C();} }
async function unlockAudioOnce(){
  if(unlockAudioOnce.done) return; unlockAudioOnce.done=true;
  try{
    ensureAudioCtx(); if(audioCtx.state==="suspended") await audioCtx.resume();
    try{ correctSound.volume=0; await correctSound.play(); correctSound.pause(); correctSound.currentTime=0; correctSound.volume=1; }catch{}
    try{ wrongSound.volume=0; await wrongSound.play(); wrongSound.pause(); wrongSound.currentTime=0; wrongSound.volume=1; }catch{}
  }catch{}
}
["pointerdown","touchstart","keydown"].forEach(ev=>window.addEventListener(ev,unlockAudioOnce,{once:true,passive:true}));
function beep(isCorrect=true){
  ensureAudioCtx(); const now=audioCtx.currentTime;
  const mk=(f,st,du)=>{const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type="sine";o.frequency.value=f;g.gain.value=0.001;o.connect(g);g.connect(audioCtx.destination);o.start(now+st);g.gain.exponentialRampToValueAtTime(0.18,now+st+0.02);o.stop(now+st+du);};
  if(isCorrect){ mk(880,0,0.18); mk(1320,0.12,0.18);} else { mk(220,0,0.22); }
}
let correctSound=new Audio("./correct.mp3"), wrongSound=new Audio("./wrong.mp3");
correctSound.preload="auto"; wrongSound.preload="auto";
let hasCorrectFile=true, hasWrongFile=true;
correctSound.onerror=()=>{hasCorrectFile=false}; wrongSound.onerror=()=>{hasWrongFile=false};
async function playSfxCorrect(){
  duckBGM(true);
  await unlockAudioOnce();
  try{
    if(hasCorrectFile){ correctSound.pause(); correctSound.currentTime=0; await correctSound.play(); }
    else{ beep(true); }
  }catch{ beep(true); }
  setTimeout(()=>duckBGM(false), 250);
}
async function playSfxWrong(){
  duckBGM(true);
  await unlockAudioOnce();
  try{
    if(hasWrongFile){ wrongSound.pause(); wrongSound.currentTime=0; await wrongSound.play(); }
    else{ beep(false); }
  }catch{ beep(false); }
  setTimeout(()=>duckBGM(false), 300);
}

/* ===== 連擊 HUD ===== */
const comboHud = ()=>document.getElementById('comboHud');
function showCombo(){ if(streak>=5){ const el=comboHud(); el.innerHTML = `<span class="flame">🔥</span> +${streak} <span class="flame">🔥</span>`; el.style.display='block'; el.classList.remove('comboPop'); void el.offsetWidth; el.classList.add('comboPop'); } else { hideCombo(); } }
function hideCombo(){ const el=comboHud(); el.style.display='none'; el.innerHTML=''; }

/* ===== 獎章 ===== */
const ACH = [
  {id:"FIRST_CORRECT",icon:"🌱",name:"森林新手",desc:"第一次答對",check:s=>s.correct>=1},
  {id:"REPLAY_USED",  icon:"🔁",name:"勤學不倦",desc:"使用過重播題目",check:s=>s.replayUsed},
  {id:"PLAY_UPPER",   icon:"🔠",name:"大寫新星",desc:"玩過大寫模式",check:s=>s.playedUpper},
  {id:"PLAY_LOWER",   icon:"🔡",name:"小寫新星",check:s=>s.playedLower},
  {id:"PLAY_MIXED",   icon:"🧭",name:"混合探險家",check:s=>s.playedMixed},
  {id:"STREAK_5",     icon:"🐿️",name:"松鼠學徒",check:s=>s.bestStreak>=5},
  {id:"STREAK_10",    icon:"🦊",name:"森林巡守",check:s=>s.bestStreak>=10},
  {id:"STREAK_20",    icon:"🦉",name:"夜梟神射",check:s=>s.bestStreak>=20},
  {id:"STREAK_30",    icon:"🦁",name:"叢林之王",check:s=>s.bestStreak>=30},
  {id:"STREAK_40",    icon:"🐯",name:"百獸霸主",check:s=>s.bestStreak>=40},
  {id:"STREAK_50",    icon:"🐉",name:"傳說連擊",check:s=>s.bestStreak>=50},
  {id:"SCORE_50",     icon:"🥉",name:"青銅橡果",check:()=>score>=50},
  {id:"SCORE_120",    icon:"🥈",name:"白銀橡果",check:()=>score>=120},
  {id:"SCORE_200",    icon:"🥇",name:"黃金橡果",check:()=>score>=200},
  {id:"SCORE_300",    icon:"🏆",name:"史詩榮耀",check:()=>score>=300},
  {id:"FINISH_50",    icon:"📘",name:"冒險完成",check:s=>s.finishedOnce},
  {id:"PERFECT_GAME", icon:"💯",name:"完美無瑕",check:s=>s.perfectGame},
  {id:"FAST_START",   icon:"⚡", name:"神速起手",check:s=>s.firstThreeCorrect>=3},
  {id:"ACCURACY_90",  icon:"🎯", name:"穩扎穩打",check:s=>(s.correct/(s.correct+s.wrong||1))>=0.9 && (s.correct+s.wrong)>=10},
  {id:"BOARD_10",     icon:"📚", name:"勤加練習",check:s=>s.boardClicks>=10},
  {id:"BOARD_ABC",    icon:"🧩", name:"多元學習",check:s=>s.boardSet.size>=8}
];
function achKeyFor(name){ return `az-achievements-${encodeURIComponent(name||'__anon__')}` }
let unlocked = {};
function renderAchievements(){
  const box=document.getElementById("achBox");
  if(!isScoredMode){ box.style.display="none"; return; }
  const wrap=document.getElementById("achWrap"); wrap.innerHTML="";
  ACH.forEach(a=>{
    const ok=!!unlocked[a.id];
    const div=document.createElement("div");
    div.className="ach"+(ok?"":" lock");
    div.innerHTML=`<div class="ic">${a.icon}</div><div><div class="name">${a.name}</div><div class="desc">${a.desc}</div></div>`;
    wrap.appendChild(div);
  });
  box.style.display="block";
}
let toastTimer=null;
function showUnlockToast(ach){
  if(!isScoredMode) return;
  const el=document.getElementById('unlockToast');
  el.querySelector('.title').textContent='成就解鎖！';
  el.querySelector('.icon').textContent=ach.icon||'🏅';
  el.querySelector('.text').textContent=`「${ach.name}」`;
  el.classList.remove('show'); void el.offsetWidth; el.classList.add('show');
  confettiBurst(800);
  clearTimeout(toastTimer); toastTimer=setTimeout(()=>{ el.classList.remove('show'); }, 1200);
}
function tryUnlock(){
  if(!isScoredMode) return;
  let changed=false;
  ACH.forEach(a=>{ if(!unlocked[a.id] && a.check(stats)){ unlocked[a.id]=true; changed=true; showUnlockToast(a); } });
  if(changed){ saveLS(achKeyFor(currentPlayerName),unlocked); renderAchievements(); renderLeaderboard(); }
}

/* ===== 排行榜（4 組） ===== */
let currentLBMode='upper';
function lbKey(m){ return `az-leaderboard-${m}` }
let LBs = {
  upper: loadLS(lbKey('upper'), []),
  lower: loadLS(lbKey('lower'), []),
  mixed: loadLS(lbKey('mixed'), []),
  extreme: loadLS(lbKey('extreme'), [])
};
function switchLB(m){
  currentLBMode=m;
  document.querySelectorAll('#leaderTabs button').forEach(b=>b.classList.remove('active'));
  document.getElementById(`tab-${m}`).classList.add('active');
  renderLeaderboard();
}
function trophySVG(kind){
  const fill = kind==='gold' ? '#d4af37' : kind==='silver' ? '#c0c0c0' : '#cd7f32';
  return `<svg class="svgTrophy" viewBox="0 0 24 24" aria-hidden="true"><path fill="${fill}" d="M8 3h8v2h3a1 1 0 0 1 1 1v1a5 5 0 0 1-5 5h-1.06A4 4 0 0 1 12 14a4 4 0 0 1-1.94-1H9a5 5 0 0 1-5-5V6a1 1 0 0 1 1-1h3V3zm10 3h-2v1a3 3 0 0 0 3-3v2a3 3 0 0 1-1 0zM6 6H4a3 3 0 0 0 3 3V6H6zm5 11h2a5 5 0 0 0 4.33 2.5H7.67A5 5 0 0 0 11 17z"/></svg>`;
}
function rowRankClass(i){ if(i===0) return 'rank1'; if(i===1) return 'rank2'; if(i===2) return 'rank3'; return ''; }
function badgesFromUnlocked(unl){ const order = ACH.map(a=>a.id); return order.filter(id=>unl[id]).map(id => ACH.find(a=>a.id===id).icon); }
function renderLeaderboard(){
  const box=document.getElementById("leaderboard"); const lb=document.getElementById("lb");
  const data = LBs[currentLBMode]||[];
  if(!data.length){
    lb.innerHTML="<tr><td class='lb-row' style='padding:10px'>暫無紀錄，快來挑戰吧！</td></tr>";
    box.style.display="block"; return;
  }
  lb.innerHTML = `
    <tr><th style="width:56px">名次</th><th>玩家</th><th style="width:100px;text-align:right">分數</th></tr>
    ${data.map((r,i)=>{
      const ic = i===0 ? trophySVG('gold') : i===1 ? trophySVG('silver') : i===2 ? trophySVG('bronze') : '';
      const badgeIcons = (r.badges||[]).slice(0,12).map(b=>`<span class="miniBadge" title="成就">${b}</span>`).join('');
      return `
        <tr class="lb-row ${rowRankClass(i)}">
          <td style="text-align:center;font-weight:800">${i+1}</td>
          <td class="nameCell">${ic}<span>${r.name}</span><span class="badgeIcons">${badgeIcons}</span></td>
          <td style="text-align:right;font-weight:800">${r.score}</td>
        </tr>`;
    }).join("")}
  `;
  box.style.display="block";
}
function clearLeaderboard(){
  if(!confirm(`確定清空「${tabLabel(currentLBMode)}」排行榜嗎？`)) return;
  LBs[currentLBMode]=[]; saveLS(lbKey(currentLBMode), LBs[currentLBMode]); renderLeaderboard();
}
function tabLabel(m){ return m==='upper'?'大寫':m==='lower'?'小寫':m==='mixed'?'混合':'極限' }
function submitScoreIfBest(){
  if(!isScoredMode || !currentPlayerName || score<=0) return;
  const list = LBs[mode] || [];
  const idx=list.findIndex(r=>r.name===currentPlayerName);
  const badges = badgesFromUnlocked(unlocked);
  if(idx>=0){ if(score>list[idx].score) list[idx]={name:currentPlayerName,score,date:new Date().toISOString(),badges}; }
  else{ list.push({name:currentPlayerName,score,date:new Date().toISOString(),badges}); }
  list.sort((a,b)=>b.score-a.score); LBs[mode]=list.slice(0,5);
  saveLS(lbKey(mode), LBs[mode]); renderLeaderboard();
}

/* ===== LocalStorage / Utils ===== */
function loadLS(key,fallback){ try{return JSON.parse(localStorage.getItem(key)||"")||fallback}catch(e){return fallback} }
function saveLS(key,val){ localStorage.setItem(key, JSON.stringify(val)); }
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

/* ===== 共用工具 ===== */
function colorForLetter(letter){
  const L = (letter.toUpperCase().charCodeAt(0) - 65 + 26) % 26;
  const hue = Math.round(L * (360/26));
  return `hsl(${hue} 80% 38%)`;
}
function maxQuestionsForMode(){ return mode==='extreme' ? EXTREME_QUESTIONS : NORMAL_QUESTIONS; }

/* ===== 遊戲流程 ===== */
let _advanceGuard = false;
function safeAdvance(delay){
  if (_advanceGuard) return;
  _advanceGuard = true;
  setTimeout(()=>{
    played++; setNumbers();
    if(played>=maxQuestionsForMode()) finishGame(); else startRound();
  }, delay);
}
async function startGame(m){
  await unlockAudioOnce();
  await setBGMTrack(m);     // 依模式切換 BGM
  mode=m; score=0; streak=0; played=0; perfectBonusApplied=false; clearTimer();
  stats={
    correct:0, wrong:0, bestStreak:0,
    playedUpper: stats.playedUpper || (m==='upper'),
    playedLower: stats.playedLower || (m==='lower'),
    playedMixed: stats.playedMixed || (m==='mixed'),
    finishedOnce:false, perfectGame:false, replayUsed:false,
    boardClicks:0, boardSet:new Set(), firstThreeCorrect:0
  };
  hideCombo();
  document.getElementById("modeSelect").style.display="none";
  document.getElementById("topWrap").style.display="block";
  document.getElementById("giveUpBtn").style.display = 'inline-block';
  renderAchievements(); renderLeaderboard(); switchLB(mode); startRound();
}
function pickLetter(){
  if(mode==="upper") return UPPER[Math.floor(Math.random()*26)];
  if(mode==="lower") return LOWER[Math.floor(Math.random()*26)];
  const pool=(mode==="mixed"||mode==="extreme") ? (Math.random()<0.5?UPPER:LOWER) : UPPER;
  if(mode==="mixed"||mode==="extreme") return pool[Math.floor(Math.random()*26)];
  return UPPER[Math.floor(Math.random()*26)];
}
async function startRound(){
  _advanceGuard = false;
  await waitSilence(300);
  stopAllSpeech();
  current=pickLetter(); locked=false;

  const opts=[current]; while(opts.length<3){const c=pickLetter(); if(!opts.includes(c)) opts.push(c);}
  opts.sort(()=>Math.random()-0.5);
  const htmlChoices = opts.map(l=>{
    const border = colorForLetter(l);
    return `<div class="choice" style="border-color:${border}; box-shadow:0 10px 20px rgba(38,58,48,.22), inset 0 0 0 2px ${border}22;" onclick="check('${l}',this)">${l}</div>`;
  }).join("");
  document.getElementById("gameArea").innerHTML = `<div id="questionLetter"></div>` + htmlChoices;
  document.getElementById("flash").textContent="";
  setNumbers();
  // 出題唸題：直接立即播放（此時通常仍在用戶手勢後的同輪互動）
  runInGesture(()=> immediatePlayLetter(current));
  startTimer();
}
function replayQuestion(){
  stats.replayUsed = true;
  runInGesture(()=> immediatePlayLetter(current));
}
function setNumbers(){
  const tag = isScoredMode ? "（計分）" : "（練習）";
  document.getElementById("scoreBoard").textContent =
    `${tag} 分數: ${score} | 題數: ${played}/${maxQuestionsForMode()} | 連對: ${streak}` +
    (isScoredMode && currentPlayerName ? ` | 玩家：${currentPlayerName} | 關卡：${tabLabel(mode)}` : ` | 關卡：${tabLabel(mode)}`);
}

/* ===== 倒數 ===== */
function startTimer(){ clearTimer(); timeLeft = QUESTION_TIME; renderTimer(); timerId = setInterval(()=>{ timeLeft = Math.max(0, timeLeft - 1); renderTimer(); if(timeLeft<=0){ clearTimer(); timeUp(); } }, 1000); }
function renderTimer(){ const t = document.getElementById('timer'); t.textContent = `⏱ ${timeLeft}s`; t.classList.toggle('red', timeLeft<=3); }
function clearTimer(){ if(timerId){ clearInterval(timerId); timerId=null; } }
function timeUp(){ if(locked) return; locked=true; clearTimer(); _advanceGuard = false; stats.wrong++; streak=0; hideCombo(); document.getElementById("flash").textContent=`⌛ 時間到！此題不計分`; try{ playSfxWrong(); }catch(e){} safeAdvance(900); setTimeout(()=>safeAdvance(0), 1500); }

/* ===== 計分規則（8 起 3 分；加計超速獎勵） ===== */
function basePointsForNext(){ const next = streak + 1; if(next>=8) return 3; if(next>=5) return 2; return 1; }
function speedBonus(){ return Math.floor(timeLeft * 0.5); }

/* ===== 判題 ===== */
async function check(val, el){
  if(locked) return; locked=true; clearTimer(); _advanceGuard = false;
  if(val===current){
    const base = basePointsForNext();
    const spd = isScoredMode ? speedBonus() : 0;
    const gain = base + spd;
    score += gain; streak++; stats.correct++; stats.bestStreak=Math.max(stats.bestStreak,streak);
    if(played<3) stats.firstThreeCorrect++;
    el.classList.add("ok");
    document.getElementById("flash").textContent=`✅ 正確！ [+${base}${spd>0?` + 加速 ${spd}`:''}]`;
    try{ await playSfxCorrect(); }catch(e){}
    tryUnlock(); showCombo(); maybeCelebration();
    safeAdvance(900); setTimeout(()=>safeAdvance(0), 1500);
  }else{
    streak=0; stats.wrong++;
    el.classList.add("bad");
    document.getElementById("flash").textContent=`❌ 再試一次`;
    try{ await playSfxWrong(); }catch(e){}
    hideCombo();
    safeAdvance(1300); setTimeout(()=>safeAdvance(0), 1800);
  }
}

/* ===== 結束（50 題全對加成 +50；極限關不加） ===== */
function finishGame(){
  try{ speechSynthesis.cancel(); }catch(e){}
  const maxQ = maxQuestionsForMode();
  stats.finishedOnce = true; if(stats.correct===maxQ && stats.wrong===0){ stats.perfectGame = true; }
  if(isScoredMode && !perfectBonusApplied && stats.correct===NORMAL_QUESTIONS && mode!=='extreme'){
    score += 50; perfectBonusApplied = true;
    document.getElementById("flash").textContent = `🎯 完美挑戰！50 題全對加成 +50 分`;
  }
  document.getElementById("topWrap").style.display="none";
  submitScoreIfBest(); tryUnlock();
  document.getElementById("modeSelect").style.display="block";
  hideCombo();
  openNextModal();
  setBGMTrack('home'); // 回首頁播放首頁音樂
}

/* —— 放棄（兩種模式通用） —— */
function openGiveUpModal(){ document.getElementById('giveUpModal').style.display='flex'; }
function closeGiveUpModal(){ document.getElementById('giveUpModal').style.display='none'; }
function giveUpGame(){
  try{ speechSynthesis.cancel(); }catch(e){}
  clearTimer();
  document.getElementById("topWrap").style.display="none";
  document.getElementById("modeSelect").style.display="block";
  document.getElementById('giveUpModal').style.display='none';
  document.getElementById("flash").textContent="已放棄本局，回到主選單。";
  hideCombo();
  setBGMTrack('home'); // 回首頁播放首頁音樂
}

/* ===== 慶祝動畫（略同前版） ===== */
const fxCanvas = document.getElementById("fxCanvas");
const fxCtx = fxCanvas.getContext("2d");
function resizeFx(){ fxCanvas.width=innerWidth; fxCanvas.height=innerHeight; }
resizeFx(); addEventListener("resize", resizeFx);
function maybeCelebration(){ switch(streak){ case 10: confettiBurst(1200); break; case 20: fireworksShow(1500); break; case 30: balloonsRise(1800); break; case 40: starShower(1500); break; case 50: goldenRibbons(1800); break; } }
function confettiBurst(duration=1200){
  const {width:w,height:h}=fxCanvas;
  const colors=["#f94144","#f3722c","#f9c74f","#90be6d","#43aa8b","#577590","#f8961e","#f9844a","#277da1","#a53860"];
  const N = Math.floor(140 * (w*h/ (1280*720)));
  const parts = Array.from({length:N},()=>({x: Math.random()*w, y: -20 - Math.random()*h*0.3, w: 6+Math.random()*10, h: 8+Math.random()*14, c: colors[Math.floor(Math.random()*colors.length)], vy: 2+Math.random()*6, vx: (Math.random()*2-1)*2, rot: Math.random()*Math.PI, spin:(Math.random()*2-1)*0.2}));
  playFrames(duration, (t,dt)=>{ fxCtx.clearRect(0,0,w,h); parts.forEach(p=>{ p.y += p.vy; p.x += p.vx; p.rot += p.spin; fxCtx.save(); fxCtx.translate(p.x,p.y); fxCtx.rotate(p.rot); fxCtx.fillStyle=p.c; fxCtx.fillRect(-p.w/2,-p.h/2,p.w,p.h); fxCtx.restore(); if(p.y>h+30) { p.y=-20; p.x=Math.random()*w; } });});
}
function fireworksShow(duration=1500){
  const {width:w,height:h}=fxCanvas; const bursts=[]; const palette=["#fff1a8","#ffd166","#ef476f","#06d6a0","#118ab2","#bbe1fa","#f78c6b"];
  for(let i=0;i<6;i++){
    const cx = Math.random()*w*0.8 + w*0.1, cy = Math.random()*h*0.4 + h*0.1;
    const count = 40+Math.floor(Math.random()*30);
    const particles = Array.from({length:count},(_,k)=>{ const a=(Math.PI*2)*(k/count); const sp=2+Math.random()*4; return {x:cx,y:cy, vx:Math.cos(a)*sp, vy:Math.sin(a)*sp, life:1, col:palette[Math.floor(Math.random()*palette.length)]}; });
    bursts.push({particles});
  }
  playFrames(duration,(t,dt)=>{ fxCtx.clearRect(0,0,w,h); bursts.forEach(b=>{ b.particles.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=0.02; p.life*=0.985; fxCtx.globalAlpha=Math.max(p.life,0); fxCtx.fillStyle=p.col; fxCtx.beginPath(); fxCtx.arc(p.x,p.y,2,0,Math.PI*2); fxCtx.fill(); fxCtx.globalAlpha=1; }); }); });
}
function balloonsRise(duration=1800){
  const {width:w,height:h}=fxCanvas; const colors=["#ffadad","#ffd6a5","#fdffb6","#caffbf","#a0c4ff","#bdb2ff"];
  const N=24; const balls = Array.from({length:N},()=>({x: Math.random()*w, y: h+30+Math.random()*h*0.4, r: 12+Math.random()*16, c: colors[Math.floor(Math.random()*colors.length)], vy: -(1.5+Math.random()*2), swing:(Math.random()*2-1)*0.6, t:Math.random()*1000}));
  playFrames(duration,(t,dt)=>{ fxCtx.clearRect(0,0,w,h); balls.forEach(b=>{ b.t += dt; b.x += Math.sin(b.t*0.003)*b.swing; b.y += b.vy; fxCtx.beginPath(); fxCtx.fillStyle=b.c; fxCtx.ellipse(b.x,b.y,b.r*0.9,b.r,0,0,Math.PI*2); fxCtx.fill(); fxCtx.strokeStyle="#999"; fxCtx.beginPath(); fxCtx.moveTo(b.x,b.y+b.r); fxCtx.lineTo(b.x,b.y+b.r+18); fxCtx.stroke(); if(b.y<-40){ b.y=h+30; b.x=Math.random()*w; } }); });
}
function starShower(duration=1500){
  const {width:w,height:h}=fxCanvas; const N=120;
  const stars=Array.from({length:N},()=>({x: Math.random()*w, y: -20 - Math.random()*h*0.4, s: 2+Math.random()*2, vy: 2+Math.random()*4, vx: 1+Math.random()*2, tilt: Math.random()*Math.PI}));
  playFrames(duration,(t,dt)=>{ fxCtx.clearRect(0,0,w,h); fxCtx.fillStyle="#fffde7"; stars.forEach(s=>{ s.x += s.vx; s.y += s.vy; s.tilt += 0.1; drawStar(s.x,s.y,s.s, s.tilt); if(s.y>h+20 || s.x>w+20){ s.y=-20; s.x=-20; } }); });
}
function drawStar(x,y,scale,rot){
  fxCtx.save(); fxCtx.translate(x,y); fxCtx.rotate(rot);
  fxCtx.beginPath();
  for(let i=0;i<5;i++){
    const a= i*(Math.PI*2)/5, r1=6*scale, r2=2.5*scale;
    fxCtx.lineTo(Math.cos(a)*r1, Math.sin(a)*r1);
    fxCtx.lineTo(Math.cos(a+Math.PI/5)*r2, Math.sin(a+Math.PI/5)*r2);
  }
  fxCtx.closePath(); fxCtx.fill(); fxCtx.restore();
}
function goldenRibbons(duration=1800){
  const {width:w,height:h}=fxCanvas; const N=80;
  const ribs=Array.from({length:N},()=>({x: Math.random()*w, y: -30 - Math.random()*h*0.3, len: 40+Math.random()*60, w: 3+Math.random()*3, vy: 3+Math.random()*5, phase: Math.random()*Math.PI*2, amp: 10+Math.random()*20, hue: 45+Math.random()*20}));
  playFrames(duration,(t,dt)=>{ fxCtx.clearRect(0,0,w,h);
    ribs.forEach(r=>{
      r.y += r.vy; const pathPoints=[];
      for(let i=0;i<r.len; i+=4){ const dx=Math.sin((i*0.2)+r.phase+t*0.004)*r.amp; pathPoints.push({x:r.x+dx, y:r.y+i}); }
      fxCtx.strokeStyle=`hsl(${r.hue} 90% 55%)`; fxCtx.lineWidth=r.w; fxCtx.lineCap="round";
      fxCtx.beginPath(); pathPoints.forEach((p,idx)=>{ if(idx===0) fxCtx.moveTo(p.x,p.y); else fxCtx.lineTo(p.x,p.y); }); fxCtx.stroke();
      if(r.y>h+50){ r.y=-30; r.x=Math.random()*w; }
    });
  });
}
function playFrames(duration, draw){
  const start = performance.now(); let last = start, rafId;
  function frame(ts){ const t = ts - start; const dt = ts - last; last = ts; draw(t,dt);
    if(t < duration) { rafId=requestAnimationFrame(frame); } else { fxCtx.clearRect(0,0,fxCanvas.width,fxCanvas.height); cancelAnimationFrame(rafId); } }
  cancelAnimationFrame(playFrames._raf||0); playFrames._raf = requestAnimationFrame(frame);
}

/* ===== 下一關 ===== */
function openNextModal(){
  const m=document.getElementById('nextModal'); const list=document.getElementById('nextList'); list.innerHTML='';
  const candidates = [
    {key:'upper', label:'大寫字母'},
    {key:'lower', label:'小寫字母'},
    {key:'mixed', label:'混合模式'},
    {key:'extreme', label:'極限挑戰'}
  ];
  const unplayed = candidates.filter(c=>{
    if(c.key==='upper') return !stats.playedUpper;
    if(c.key==='lower') return !stats.playedLower;
    if(c.key==='mixed') return !stats.playedMixed;
    if(c.key==='extreme') return true;
  });
  if(unplayed.length){
    document.getElementById('nextDesc').textContent = '你可以回主選單，或直接挑戰尚未進行的關卡：';
    unplayed.forEach(c=>{
      const btn=document.createElement('button'); btn.textContent='➤ 進入『'+c.label+'』'; btn.onclick=()=>{ m.style.display='none'; startGame(c.key); }; list.appendChild(btn);
    });
  }else{
    document.getElementById('nextDesc').textContent = '本回合都體驗過了！你可以回主選單或重玩任一模式：';
    candidates.forEach(c=>{
      const btn=document.createElement('button'); btn.textContent='重新挑戰『'+c.label+'』'; btn.onclick=()=>{ m.style.display='none'; startGame(c.key); }; list.appendChild(btn);
    });
  }
  m.style.display='flex';
}
function backToMenu(){ document.getElementById('nextModal').style.display='none'; document.getElementById("modeSelect").style.display="block"; setBGMTrack('home'); }

/* ===== 常駐學習板：點卡片 → 字母（同步）→ 1 秒 → 動物（同步） ===== */
function buildAlphabetBoard(){
  const board=document.getElementById("alphabetBoard"); board.innerHTML="";
  UPPER.forEach(l=>{
    const card=document.createElement("div"); card.className="letterCard";
    const mini=document.createElement("div"); mini.className="mini"; mini.textContent=animalEmoji[l]||"🫧";
    const lab=document.createElement("div"); lab.className="lab"; lab.innerHTML=`<div class="l">${l}</div><div class="a">${animalWords[l]}</div>`;
    card.appendChild(mini); card.appendChild(lab);
    card.onclick=()=>{ 
      stats.boardClicks++; stats.boardSet.add(l);
      runInGesture(() => {
        immediatePlayLetter(l);
        setTimeout(()=>{ immediatePlayWord(animalWords[l]); }, 1000);
      });
      tryUnlock();
    };
    board.appendChild(card);
  });
}
buildAlphabetBoard();

/* ===== 初始化：首頁 BGM、排行榜、iOS 聲音門檻 ===== */
(function init(){
  updateBgmBtn();
  const vol = document.getElementById('bgmVol'); if(vol) vol.value = bgmVol;
  setBGMTrack('home');   // 首頁曲
  switchLB('upper'); renderLeaderboard();
  showSoundGateIfNeeded();
})();

/* ===== 模式選擇彈窗 ===== */
function openScoreModal(letterMode){
  pendingLetterMode = letterMode;
  const m = document.getElementById("scoreModal");
  m.style.display="flex";
  document.querySelectorAll('input[name="m"]').forEach(r=>{ if(r.value==='scored') r.checked=true; });
  document.getElementById("playerName").value = currentPlayerName || "";
}
function closeScoreModal(){ document.getElementById("scoreModal").style.display="none"; }
function confirmScoreChoice(){
  const selected = document.querySelector('input[name="m"]:checked')?.value || 'scored';
  if(selected==='scored'){
    const name = (document.getElementById("playerName").value||"").trim();
    if(!name){ alert("計分模式需要輸入玩家姓名喔！"); return; }
    isScoredMode = true; currentPlayerName = name;
    unlocked = loadLS(achKeyFor(currentPlayerName), {}) || {};
  }else{
    isScoredMode = false; currentPlayerName = null;
    unlocked = {}; // 練習不解鎖
  }
  closeScoreModal(); startGame(pendingLetterMode||'upper');
}

/* ===== iOS 相容：啟用聲音門檻 ===== */
function isIOS(){
  return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
         (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
}
function showSoundGateIfNeeded(){
  if (!unlockAudioOnce.done && isIOS()) {
    document.getElementById('soundGate').style.display = 'flex';
  }
}
async function enableSoundIOS(){
  try{
    await unlockAudioOnce();
    ensureBgmPipeline();
    if (bgmAudioCtx?.state === 'suspended') await bgmAudioCtx.resume();
    setBGMVolume(bgmVol);

    // 預熱：嘗試 A.mp3 / A.wav 任一能播即可（靜音快速播放）
    for(const src of letterSources('A')){
      try{
        const pre = new Audio(src);
        pre.volume = 0; pre.preload='auto'; pre.setAttribute('playsinline','');
        await pre.play(); pre.pause(); pre.currentTime = 0;
        break;
      }catch(e){ /* 換下一個副檔名 */ }
    }
  }catch(e){}
  document.getElementById('soundGate').style.display = 'none';
  try { await setBGMTrack('home'); await playBGM(); } catch {}
}

/* ===== BGM 切換（整合管線） ===== */
async function setBGMTrack(key){
  currentBgmKey = key;
  const src = BGM_SOURCES[key] || BGM_SOURCES.home;
  try { bgmEl.pause(); } catch {}
  bgmEl.src = src; bgmEl.currentTime = 0;

  ensureBgmPipeline();   // 建立 WebAudio 管線
  setBGMVolume(bgmVol);  // 同步目前音量到管線

  if (bgmOn) { try { await unlockAudioOnce(); await playBGM(); } catch {} }
}
</script>
</body>
</html>
